<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Arc Fabric</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#09090b;--surface:#111113;--surface2:#18181b;--surface3:#1f1f23;
  --border:#27272a;--border2:#3f3f46;
  --text:#fafafa;--text2:#a1a1aa;--text3:#71717a;
  --accent:#7c3aed;--accent2:#8b5cf6;--accent-bg:rgba(124,58,237,.08);
  --green:#22c55e;--green-bg:rgba(34,197,94,.12);
  --orange:#f59e0b;--orange-bg:rgba(245,158,11,.12);
  --red:#ef4444;--red-bg:rgba(239,68,68,.12);
  --blue:#3b82f6;--blue-bg:rgba(59,130,246,.12);
  --radius:10px;--radius-lg:14px;
}
body{font-family:Inter,-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
a{color:var(--accent2);text-decoration:none}

/* Layout */
.app{display:flex;flex-direction:column;height:100vh}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 24px;border-bottom:1px solid var(--border);background:var(--surface)}
.logo{font-size:20px;font-weight:700;letter-spacing:-.3px}
.logo span{color:var(--accent2)}
.gpu-bar{display:flex;gap:8px}
.gpu-chip{display:flex;align-items:center;gap:6px;padding:5px 12px;border-radius:20px;background:var(--surface2);border:1px solid var(--border);font-size:11px;font-weight:500;color:var(--text2)}
.gpu-chip .dot{width:7px;height:7px;border-radius:50%}
.gpu-chip .dot.free{background:var(--green)}.gpu-chip .dot.occupied{background:var(--orange)}

.main{display:flex;flex:1;overflow:hidden}

/* Sidebar */
.sidebar{display:flex;flex-direction:column;border-right:1px solid var(--border);background:var(--surface);overflow-y:auto;min-width:300px;max-width:340px;flex-shrink:0}
.section{padding:16px 20px;border-bottom:1px solid var(--border)}
.section:last-child{border-bottom:none;flex:1}
.section-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);margin-bottom:10px}

/* Models */
.model-list{display:flex;flex-direction:column;gap:4px}
.model-family{margin-bottom:4px}
.model-family-header{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);padding:6px 4px 2px;display:flex;align-items:center;gap:6px}
.model-family-header .count{font-size:8px;background:var(--surface3);padding:1px 5px;border-radius:6px}
.model-card{display:flex;align-items:start;gap:10px;padding:8px 10px;border-radius:var(--radius);border:1.5px solid transparent;background:var(--surface2);cursor:pointer;transition:all .12s}
.model-card:hover{border-color:var(--border2);background:var(--surface3)}
.model-card.selected{border-color:var(--accent);background:var(--accent-bg)}
.model-card .info{flex:1;min-width:0}
.model-card .name{font-size:12px;font-weight:600;line-height:1.3}
.model-card .desc{font-size:10px;color:var(--text3);line-height:1.3;margin-top:1px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.badge-col{display:flex;flex-direction:column;align-items:flex-end;gap:2px;flex-shrink:0}
.badge{font-size:8px;font-weight:700;padding:2px 6px;border-radius:8px;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap}
.badge.cold{background:var(--surface3);color:var(--text3)}
.badge.warm{background:var(--green-bg);color:var(--green)}
.badge.warming{background:var(--orange-bg);color:var(--orange)}
.badge.error{background:var(--red-bg);color:var(--red)}
.badge.shared{background:var(--blue-bg);color:var(--blue);font-size:7px}

/* Params */
.param-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.param-group{display:flex;flex-direction:column;gap:3px}
.param-group.full{grid-column:1/-1}
.param-group label{font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.5px}
.param-group input,.param-group textarea{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:8px 10px;color:var(--text);font-size:13px;font-family:inherit;outline:none;transition:border .12s}
.param-group input:focus,.param-group textarea:focus{border-color:var(--accent)}
.param-group textarea{resize:vertical;min-height:72px;line-height:1.5}

/* Caching controls */
.cache-section{margin-top:6px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);display:none}
.cache-section.visible{display:block}
.cache-toggle{display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;font-weight:600;color:var(--text2)}
.cache-toggle input[type=checkbox]{width:14px;height:14px;accent-color:var(--accent)}
.cache-params{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:8px;display:none}
.cache-params.visible{display:grid}
.cache-params .param-group label{font-size:9px}
.cache-params .param-group input{padding:6px 8px;font-size:12px}

.gen-btn{width:100%;padding:12px;border:none;border-radius:var(--radius);background:var(--accent);color:#fff;font-size:14px;font-weight:600;cursor:pointer;transition:all .15s;margin-top:6px}
.gen-btn:hover{background:var(--accent2)}
.gen-btn:disabled{opacity:.4;cursor:not-allowed}

/* Active jobs bar */
.active-jobs{display:flex;flex-direction:column;gap:6px;margin-top:8px}
.active-job{display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;font-size:11px;color:var(--text2);cursor:pointer;transition:border .12s}
.active-job:hover{border-color:var(--accent)}
.active-job.viewing{border-color:var(--accent);background:var(--accent-bg)}
.active-job .aj-spinner{width:12px;height:12px;border:2px solid var(--border);border-top:2px solid var(--orange);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}
.active-job .aj-done{width:12px;height:12px;border-radius:50%;background:var(--green);flex-shrink:0}
.active-job .aj-fail{width:12px;height:12px;border-radius:50%;background:var(--red);flex-shrink:0}
.active-job .aj-prompt{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.active-job .aj-time{font-variant-numeric:tabular-nums;color:var(--text3);flex-shrink:0}

/* Output panel */
.output{display:flex;flex-direction:column;overflow-y:auto;background:var(--bg);flex:1;min-width:0}
.output-inner{padding:24px;display:flex;flex-direction:column;gap:20px;max-width:960px;margin:0 auto;width:100%}

.video-box{position:relative;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;aspect-ratio:16/9;display:flex;align-items:center;justify-content:center}
.video-box video{width:100%;height:100%;object-fit:contain;display:block}
.video-box .placeholder{text-align:center;color:var(--text3)}
.video-box .placeholder svg{width:48px;height:48px;opacity:.25;margin-bottom:10px}
.video-box .placeholder p{font-size:13px}

.overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(9,9,11,.88);z-index:10}
.spinner{width:36px;height:36px;border:3px solid var(--border);border-top:3px solid var(--accent2);border-radius:50%;animation:spin .7s linear infinite;margin-bottom:14px}
@keyframes spin{to{transform:rotate(360deg)}}
.overlay .label{color:var(--text2);font-size:13px}
.overlay .timer{color:var(--accent2);font-size:22px;font-weight:700;margin-top:6px;font-variant-numeric:tabular-nums}

.meta-row{display:flex;gap:16px;flex-wrap:wrap;font-size:12px;color:var(--text3)}
.meta-row strong{color:var(--text2)}

/* Log box */
.log-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);max-height:180px;overflow-y:auto}
.log-header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid var(--border);font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1px;position:sticky;top:0;background:var(--surface);z-index:1}
.log-content{padding:8px 12px;font-family:'SF Mono',Monaco,Consolas,monospace;font-size:11px;line-height:1.6;color:var(--text3);white-space:pre-wrap;word-break:break-all}

/* History */
.history-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);margin-bottom:10px}
.history-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
.history-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;cursor:pointer;transition:border .12s}
.history-item:hover{border-color:var(--accent)}
.history-item video{width:100%;aspect-ratio:16/9;object-fit:cover;display:block}
.history-item .info{padding:8px 10px}
.history-item .prompt-text{font-size:11px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text)}
.history-item .detail{font-size:10px;color:var(--text3);margin-top:2px}

.empty{color:var(--text3);font-size:12px}

/* Interactive builder */
.ix-status{font-size:12px;color:var(--text2);line-height:1.5;margin-bottom:8px;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;white-space:pre-line;max-height:120px;overflow-y:auto}
.ix-chunk-info{font-size:13px;font-weight:600;color:var(--accent2);margin-bottom:8px}
.ix-video-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:6px}
.ix-video-small{aspect-ratio:16/9}
.ix-video-small video{width:100%;height:100%;object-fit:contain;display:block}
.ix-video-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.ix-nav-row{display:flex;gap:6px;margin-top:8px}
.ix-nav-btn{flex:1;padding:8px;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;color:#fff;transition:opacity .12s}
.ix-nav-btn:hover{opacity:.85}
.ix-nav-btn:disabled{opacity:.4;cursor:not-allowed}
.ix-nav-btn.back{background:var(--surface3);color:var(--text2)}
.ix-nav-btn.reset{background:var(--surface3);color:var(--text2)}
.ix-nav-btn.finalize{background:var(--green)}
.ix-history{display:flex;flex-direction:column;gap:4px}
.ix-history-row{display:flex;gap:10px;padding:6px 10px;background:var(--surface);border:1px solid var(--border);border-radius:8px;font-size:11px;color:var(--text2)}
.ix-history-row .num{font-weight:700;color:var(--accent2);min-width:20px}
.ix-history-row .time{color:var(--text3);min-width:55px}
.ix-history-row .prompt{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ix-step-badge{display:inline-block;font-size:9px;font-weight:700;padding:2px 6px;border-radius:6px;background:var(--accent-bg);color:var(--accent2);margin-bottom:6px}

@media(max-width:600px){.main{flex-direction:column}.sidebar{max-width:none;min-width:0;border-right:none;border-bottom:1px solid var(--border)}.ix-video-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">Arc <span>Fabric</span></div>
    <div class="gpu-bar" id="gpuBar"></div>
  </header>
  <div class="main">
    <div class="sidebar">
      <div class="section">
        <div class="section-title">Model</div>
        <div class="model-list" id="modelList"></div>
      </div>
      <div id="standardSidebar">
        <div class="section">
          <div class="section-title">Parameters</div>
          <div class="param-grid">
            <div class="param-group full">
              <label>Prompt</label>
              <textarea id="prompt">A golden retriever running joyfully on a sunny beach, waves crashing in the background, cinematic lighting</textarea>
            </div>
            <div class="param-group"><label>Width</label><input type="number" id="width" value="832"></div>
            <div class="param-group"><label>Height</label><input type="number" id="height" value="480"></div>
            <div class="param-group"><label>Frames</label><input type="number" id="numFrames" value="33"></div>
            <div class="param-group"><label>Seed</label><input type="number" id="seed" value="42"></div>
          </div>
          <div class="cache-section" id="cacheSection">
            <label class="cache-toggle">
              <input type="checkbox" id="enableCaching" onchange="toggleCacheParams()">
              Enable step caching (skip redundant steps)
            </label>
            <div class="cache-params" id="cacheParams">
              <div class="param-group"><label>Start step</label><input type="number" id="cacheStart" value="2"></div>
              <div class="param-group"><label>End step</label><input type="number" id="cacheEnd" value="8"></div>
              <div class="param-group"><label>Interval</label><input type="number" id="cacheInterval" value="3"></div>
            </div>
          </div>
        </div>
        <div class="section">
          <button class="gen-btn" id="genBtn" onclick="generate()">Generate Video</button>
          <div class="active-jobs" id="activeJobs"></div>
        </div>
      </div>
      <div id="interactiveSidebar" style="display:none">
        <div class="section">
          <div class="section-title">Interactive Video Builder</div>
          <div id="ixStatus" class="ix-status">Click Setup Model to begin</div>
          <button class="gen-btn" id="ixSetupBtn" onclick="ixSetup()">Setup Model</button>
          <div class="param-grid" style="margin-top:8px">
            <div class="param-group"><label>Seed</label><input type="number" id="ixSeed" value="42"></div>
            <div class="param-group"><label>Max Chunks</label><input type="number" id="ixMaxChunks" value="12"></div>
          </div>
        </div>
        <div class="section" id="ixGroundingSection" style="display:none">
          <div class="ix-step-badge">Step 1</div>
          <div class="section-title">Set the Scene</div>
          <div class="param-group full">
            <label>Scene Description (grounding)</label>
            <textarea id="ixGrounding" placeholder="e.g., A young woman with red hair standing in a misty forest at dawn" style="min-height:56px"></textarea>
          </div>
          <button class="gen-btn" onclick="ixSetGrounding()" style="margin-top:6px">Set Scene</button>
        </div>
        <div class="section" id="ixChunkSection" style="display:none">
          <div class="ix-step-badge">Step 2</div>
          <div class="section-title">Build Chunks</div>
          <div id="ixChunkInfo" class="ix-chunk-info">Chunk 1 (0-10s)</div>
          <div class="param-group full">
            <label>What happens in this chunk?</label>
            <textarea id="ixChunkPrompt" placeholder="e.g., she slowly turns to face the camera, wind blowing through her hair" style="min-height:56px"></textarea>
          </div>
          <button class="gen-btn" id="ixGenBtn" onclick="ixGenerateChunk()">Generate Chunk</button>
          <div class="ix-nav-row">
            <button class="ix-nav-btn back" onclick="ixGoBack()" id="ixBackBtn" disabled>Back</button>
            <button class="ix-nav-btn reset" onclick="ixReset()">Reset</button>
            <button class="ix-nav-btn finalize" onclick="ixFinalize()" id="ixFinalizeBtn" disabled>Finalize</button>
          </div>
        </div>
        <div class="section" id="ixLogSection" style="display:none">
          <div class="section-title">Worker Log</div>
          <div class="log-box" style="max-height:120px">
            <div class="log-content" id="ixLogContent" style="font-size:10px"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="output">
      <div class="output-inner" id="standardOutput">
        <div class="video-box" id="videoBox">
          <div class="placeholder" id="placeholder">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polygon points="5 3 19 12 5 21 5 3"/></svg>
            <p>Select a model and hit Generate</p>
          </div>
        </div>
        <div class="meta-row" id="jobMeta"></div>
        <div class="log-box" id="logBox" style="display:none">
          <div class="log-header"><span>Generation Log</span></div>
          <div class="log-content" id="logContent"></div>
        </div>
        <div>
          <div class="history-title">Recent Generations</div>
          <div class="history-grid" id="historyGrid"><div class="empty">No videos generated yet</div></div>
        </div>
      </div>
      <div class="output-inner" id="interactiveOutput" style="display:none">
        <div class="ix-video-grid">
          <div>
            <div class="ix-video-label">Last Generated Chunk</div>
            <div class="video-box ix-video-small" id="ixChunkBox">
              <div class="placeholder"><p>No chunk generated yet</p></div>
            </div>
          </div>
          <div>
            <div class="ix-video-label">Full Video So Far</div>
            <div class="video-box ix-video-small" id="ixFullBox">
              <div class="placeholder"><p>Generate chunks to build video</p></div>
            </div>
          </div>
        </div>
        <div id="ixChunkHistory">
          <div class="history-title" style="margin-top:8px">Chunk Timeline</div>
          <div id="ixHistoryTable" class="ix-history">
            <div class="empty">No chunks generated yet</div>
          </div>
        </div>
        <div id="ixFinalSection" style="display:none">
          <div class="history-title" style="margin-top:16px">Final Video</div>
          <div class="video-box" id="ixFinalBox">
            <div class="placeholder"><p>Click Finalize to assemble complete video</p></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
let selectedModel = null;
let viewingJobId = null;
let modelsData = [];

// Track all active (running/queued) jobs for concurrent polling
const activeJobs = new Map(); // jobId -> { startTime, interval }

async function fetchJSON(url, opts) {
  const r = await fetch(url, opts);
  return r.json();
}

function getFamily(id) {
  if (id.startsWith('wan21') || id.startsWith('hybrid_wan')) return 'Wan 2.1';
  if (id.startsWith('longlive')) return 'LongLive';
  if (id.startsWith('ltx') || id.startsWith('hybrid_ltx')) return 'LTX-Video';
  return 'Other';
}

function isHybridModel(id) {
  if (!id) return false;
  const m = modelsData.find(x => x.id === id);
  return m && m.is_hybrid;
}

async function loadModels() {
  modelsData = await fetchJSON('/api/models');
  const list = $('#modelList');
  const families = {};
  modelsData.forEach(m => {
    const f = getFamily(m.id);
    if (!families[f]) families[f] = [];
    families[f].push(m);
  });
  list.innerHTML = Object.entries(families).map(([family, models]) => `
    <div class="model-family">
      <div class="model-family-header">${family}<span class="count">${models.length}</span></div>
      ${models.map(m => {
        const shared = m.shared_via ? `<div class="badge shared">via ${m.shared_via.replace('hybrid_','')}</div>` : '';
        const gpuLabel = m.gpu_id !== null ? ' (GPU ' + m.gpu_id + ')' : '';
        return `
        <div class="model-card${selectedModel===m.id?' selected':''}" data-id="${m.id}" onclick="selectModel('${m.id}')">
          <div class="info">
            <div class="name">${m.display_name}</div>
            <div class="desc">${m.description}</div>
          </div>
          <div class="badge-col">
            <div class="badge ${m.status}">${m.status}${gpuLabel}</div>
            ${shared}
          </div>
        </div>`;
      }).join('')}
    </div>
  `).join('');
  if (!selectedModel && modelsData.length) selectModel(modelsData[0].id);
}

function selectModel(id) {
  selectedModel = id;
  const m = modelsData.find(x => x.id === id);
  if (!m) return;
  $('#width').value = m.defaults.width;
  $('#height').value = m.defaults.height;
  $('#numFrames').value = m.defaults.num_frames;
  document.querySelectorAll('.model-card').forEach(el => {
    el.classList.toggle('selected', el.dataset.id === id);
  });

  // Show/hide caching section for hybrid models
  const cacheSection = $('#cacheSection');
  if (isHybridModel(id)) {
    cacheSection.classList.add('visible');
  } else {
    cacheSection.classList.remove('visible');
  }

  // Toggle interactive mode
  const isIx = (id === 'longlive_interactive');
  $('#standardSidebar').style.display = isIx ? 'none' : '';
  $('#interactiveSidebar').style.display = isIx ? '' : 'none';
  $('#standardOutput').style.display = isIx ? 'none' : '';
  $('#interactiveOutput').style.display = isIx ? '' : 'none';
}

function toggleCacheParams() {
  const checked = $('#enableCaching').checked;
  const params = $('#cacheParams');
  if (checked) {
    params.classList.add('visible');
  } else {
    params.classList.remove('visible');
  }
}

async function loadGPUs() {
  const gpus = await fetchJSON('/api/gpus');
  $('#gpuBar').innerHTML = gpus.map(g => `
    <div class="gpu-chip">
      <div class="dot ${g.status}"></div>
      <span>GPU ${g.gpu_id}${g.model_name ? ': '+g.model_name : ''}</span>
    </div>
  `).join('');
}

async function generate() {
  if (!selectedModel) return;

  const body = {
    model_id: selectedModel,
    prompt: $('#prompt').value,
    width: +$('#width').value,
    height: +$('#height').value,
    num_frames: +$('#numFrames').value,
    seed: +$('#seed').value,
  };

  // Include caching params if enabled
  if (isHybridModel(selectedModel) && $('#enableCaching').checked) {
    body.enable_caching = true;
    body.cache_start_step = +$('#cacheStart').value || 2;
    body.cache_end_step = +$('#cacheEnd').value || null;
    body.cache_interval = +$('#cacheInterval').value || 3;
  }

  const data = await fetchJSON('/api/generate', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body),
  });

  const jobId = data.job_id;

  // Track this job
  activeJobs.set(jobId, { startTime: Date.now(), modelId: selectedModel, prompt: body.prompt });

  // Show this job in the video box
  viewJob(jobId);

  // Start polling this job
  pollJob(jobId);

  // Refresh state
  loadModels();
  loadGPUs();
  renderActiveJobs();
}

function viewJob(jobId) {
  viewingJobId = jobId;
  const info = activeJobs.get(jobId);
  if (info) {
    showOverlay('Loading model...');
    startTimer(info.startTime);
    $('#logBox').style.display = 'block';
    $('#logContent').textContent = 'Waiting for process to start...\n';
  }
  renderActiveJobs();
}

function showOverlay(text) {
  const box = $('#videoBox');
  const ph = $('#placeholder');
  if (ph) ph.style.display = 'none';

  let ov = box.querySelector('.overlay');
  if (!ov) {
    ov = document.createElement('div');
    ov.className = 'overlay';
    box.appendChild(ov);
  }
  ov.innerHTML = `<div class="spinner"></div><div class="label">${text}</div><div class="timer">0.0s</div>`;
  ov.style.display = 'flex';
}

function hideOverlay() {
  const ov = document.querySelector('.overlay');
  if (ov) ov.style.display = 'none';
}

let _timerInterval = null;
function startTimer(startTime) {
  if (_timerInterval) clearInterval(_timerInterval);
  _timerInterval = setInterval(() => {
    const el = document.querySelector('.overlay .timer');
    if (el) el.textContent = ((Date.now() - startTime) / 1000).toFixed(1) + 's';
  }, 100);
}

function stopTimer() {
  if (_timerInterval) { clearInterval(_timerInterval); _timerInterval = null; }
}

async function pollJob(jobId) {
  const job = await fetchJSON(`/api/jobs/${jobId}`);

  // Update the video panel if we're viewing this job
  if (viewingJobId === jobId) {
    const ov = document.querySelector('.overlay');
    if (ov && ov.style.display !== 'none') {
      const label = ov.querySelector('.label');
      if (job.status === 'running') {
        const servedBy = job.served_by;
        const extra = servedBy && servedBy !== job.model_id ? ` (via ${servedBy})` : '';
        label.textContent = 'Generating video...' + extra;
      }
      else if (job.status === 'queued') label.textContent = 'Queued...';
    }
    // Fetch logs
    try {
      const logData = await fetchJSON(`/api/logs/${jobId}`);
      if (logData.log) {
        const logEl = $('#logContent');
        logEl.textContent = logData.log;
        logEl.scrollTop = logEl.scrollHeight;
      }
    } catch(e) {}
  }

  if (job.status === 'completed') {
    activeJobs.delete(jobId);
    renderActiveJobs();
    if (viewingJobId === jobId) {
      stopTimer();
      hideOverlay();
      showVideo(job);
    }
    loadModels(); loadGPUs(); loadHistory();
    return;
  }
  if (job.status === 'failed') {
    activeJobs.delete(jobId);
    renderActiveJobs();
    if (viewingJobId === jobId) {
      stopTimer();
      showError(job.error);
    }
    loadModels(); loadGPUs();
    return;
  }

  setTimeout(() => pollJob(jobId), 2000);
}

function renderActiveJobs() {
  const container = $('#activeJobs');
  if (activeJobs.size === 0) {
    container.innerHTML = '';
    return;
  }
  let html = '';
  for (const [jobId, info] of activeJobs) {
    const elapsed = ((Date.now() - info.startTime) / 1000).toFixed(0);
    const viewing = viewingJobId === jobId ? ' viewing' : '';
    html += `
      <div class="active-job${viewing}" onclick="switchToJob('${jobId}')">
        <div class="aj-spinner"></div>
        <div class="aj-prompt">${(info.prompt || '').substring(0, 40)}</div>
        <div class="aj-time">${elapsed}s</div>
      </div>`;
  }
  container.innerHTML = html;
}

// Periodically update active job timers
setInterval(renderActiveJobs, 1000);

function switchToJob(jobId) {
  viewingJobId = jobId;
  const info = activeJobs.get(jobId);
  if (info) {
    showOverlay('Generating video...');
    startTimer(info.startTime);
    $('#logBox').style.display = 'block';
    $('#logContent').textContent = 'Loading log...\n';
  }
  renderActiveJobs();
}

function showVideo(job) {
  const box = $('#videoBox');
  let video = box.querySelector('video');
  if (!video) {
    video = document.createElement('video');
    video.controls = true;
    video.autoplay = true;
    video.loop = true;
    box.appendChild(video);
  }
  video.src = job.output_path + '?t=' + Date.now();
  video.style.display = 'block';

  const m = modelsData.find(x => x.id === job.model_id);
  const servedBy = job.served_by && job.served_by !== job.model_id
    ? `<span>Served by: <strong>${job.served_by}</strong></span>` : '';
  const cacheBadge = job.enable_caching ? `<span>Caching: <strong>ON</strong></span>` : '';
  $('#jobMeta').innerHTML = `
    <span>Model: <strong>${m ? m.display_name : job.model_id}</strong></span>
    <span>Time: <strong>${job.elapsed?.toFixed(1)}s</strong></span>
    <span>Seed: <strong>${$('#seed').value}</strong></span>
    ${servedBy}${cacheBadge}
  `;
}

function showError(error) {
  const box = $('#videoBox');
  let ov = box.querySelector('.overlay');
  if (!ov) { ov = document.createElement('div'); ov.className = 'overlay'; box.appendChild(ov); }
  ov.style.display = 'flex';
  ov.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
    <div style="color:var(--red);font-size:14px;font-weight:600;margin-top:12px">Generation Failed</div>
    <div style="color:var(--text3);font-size:12px;margin-top:6px;max-width:500px;text-align:center;line-height:1.5">${(error||'').substring(0,300)}</div>
  `;
}

async function loadHistory() {
  const allJobs = await fetchJSON('/api/jobs');
  const completed = allJobs.filter(j => j.status === 'completed' && j.output_path);
  const grid = $('#historyGrid');
  if (!completed.length) { grid.innerHTML = '<div class="empty">No videos generated yet</div>'; return; }
  grid.innerHTML = completed.slice(0, 12).map(j => {
    const m = modelsData.find(x => x.id === j.model_id);
    return `
    <div class="history-item" onclick="replayVideo('${j.output_path}','${(j.prompt||'').replace(/'/g,"\\'")}','${m?m.display_name:j.model_id}',${j.elapsed||0})">
      <video src="${j.output_path}" muted preload="metadata"></video>
      <div class="info">
        <div class="prompt-text">${j.prompt||''}</div>
        <div class="detail">${m?m.display_name:j.model_id} &middot; ${(j.elapsed||0).toFixed(1)}s</div>
      </div>
    </div>`;
  }).join('');
}

function replayVideo(path, prompt, name, elapsed) {
  hideOverlay();
  stopTimer();
  viewingJobId = null;
  const box = $('#videoBox');
  let video = box.querySelector('video');
  if (!video) { video = document.createElement('video'); video.controls=true; video.autoplay=true; video.loop=true; box.appendChild(video); }
  video.src = path;
  video.style.display = 'block';
  $('#jobMeta').innerHTML = `<span>Model: <strong>${name}</strong></span><span>Time: <strong>${elapsed.toFixed(1)}s</strong></span>`;
  $('#logBox').style.display = 'none';
}

loadModels(); loadGPUs(); loadHistory();
setInterval(() => { loadModels(); loadGPUs(); }, 8000);

// ---------------------------------------------------------------------------
// Interactive chunk-by-chunk mode
// ---------------------------------------------------------------------------
let ixChunks = [];
let ixCurrentChunk = 0;
let ixIsSetup = false;
let ixGroundingSet = false;
let ixBusy = false;
let ixLogPoll = null;
let ixChunkDuration = 10;

function ixSetStatus(text) {
  $('#ixStatus').textContent = text;
}

function ixUpdateChunkInfo() {
  const n = ixCurrentChunk + 1;
  const s = ixCurrentChunk * ixChunkDuration;
  const e = s + ixChunkDuration;
  $('#ixChunkInfo').textContent = `Chunk ${n} (${s}-${e}s)`;
}

function ixUpdateNavButtons() {
  const back = $('#ixBackBtn');
  const fin = $('#ixFinalizeBtn');
  if (back) back.disabled = (ixCurrentChunk === 0);
  if (fin) fin.disabled = (ixCurrentChunk === 0);
}

function ixShowVideo(boxId, url) {
  const box = document.getElementById(boxId);
  if (!box) return;
  const ph = box.querySelector('.placeholder');
  if (ph) ph.style.display = 'none';
  let v = box.querySelector('video');
  if (!v) {
    v = document.createElement('video');
    v.controls = true; v.autoplay = true; v.loop = true;
    box.appendChild(v);
  }
  v.src = url + '?t=' + Date.now();
  v.style.display = 'block';
}

function ixClearVideo(boxId, text) {
  const box = document.getElementById(boxId);
  if (!box) return;
  const v = box.querySelector('video');
  if (v) { v.src = ''; v.style.display = 'none'; }
  let ph = box.querySelector('.placeholder');
  if (!ph) {
    ph = document.createElement('div');
    ph.className = 'placeholder';
    ph.innerHTML = '<p></p>';
    box.appendChild(ph);
  }
  ph.style.display = '';
  ph.querySelector('p').textContent = text;
}

function ixRenderHistory() {
  const el = $('#ixHistoryTable');
  if (!ixChunks.length) {
    el.innerHTML = '<div class="empty">No chunks generated yet</div>';
    return;
  }
  el.innerHTML = ixChunks.map(c => `
    <div class="ix-history-row">
      <span class="num">${c.num}</span>
      <span class="time">${c.time_range}</span>
      <span class="prompt">${c.prompt}</span>
    </div>
  `).join('');
}

function ixStartLogPolling() {
  if (ixLogPoll) return;
  $('#ixLogSection').style.display = '';
  ixLogPoll = setInterval(async () => {
    try {
      const d = await fetchJSON('/api/interactive/logs');
      if (d.log) {
        const el = $('#ixLogContent');
        el.textContent = d.log;
        el.parentElement.scrollTop = el.parentElement.scrollHeight;
      }
    } catch(e) {}
  }, 3000);
}

function ixStopLogPolling() {
  if (ixLogPoll) { clearInterval(ixLogPoll); ixLogPoll = null; }
}

async function ixSetup() {
  if (ixBusy) return;
  ixBusy = true;
  const btn = $('#ixSetupBtn');
  btn.disabled = true;
  btn.textContent = 'Starting worker...';
  ixSetStatus('Starting worker and loading model...\nThis takes 1-5 minutes on first run.');
  ixStartLogPolling();

  try {
    const result = await fetchJSON('/api/interactive/setup', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        seed: +(document.getElementById('ixSeed').value) || 42,
        max_chunks: +(document.getElementById('ixMaxChunks').value) || 12,
      }),
    });
    ixIsSetup = true;
    ixSetStatus(
      `Model loaded! Session: ${result.session_id}\n` +
      `GPU: ${result.gpu || 'N/A'} | VRAM: ${result.vram_free || 'N/A'} | Load: ${result.load_time || 'N/A'}\n\n` +
      `Describe the main scene below to set the visual grounding.`
    );
    btn.textContent = 'Model Ready';
    $('#ixGroundingSection').style.display = '';
    loadModels(); loadGPUs();
  } catch (e) {
    ixSetStatus(`Setup failed: ${e.message || e}`);
    btn.disabled = false;
    btn.textContent = 'Retry Setup';
  }
  ixBusy = false;
}

async function ixSetGrounding() {
  if (ixBusy) return;
  const g = $('#ixGrounding').value.trim();
  if (!g) { ixSetStatus('Please enter a scene description.'); return; }
  ixBusy = true;
  ixSetStatus('Setting scene grounding...');

  try {
    await fetchJSON('/api/interactive/grounding', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ grounding: g, skip_ai: true }),
    });
    ixGroundingSet = true;
    ixCurrentChunk = 0;
    ixChunks = [];
    ixSetStatus(`Scene set: "${g}"\n\nNow describe what happens in each ~${ixChunkDuration}s chunk.`);
    ixUpdateChunkInfo();
    ixUpdateNavButtons();
    $('#ixChunkSection').style.display = '';
  } catch (e) {
    ixSetStatus(`Grounding failed: ${e.message || e}`);
  }
  ixBusy = false;
}

async function ixGenerateChunk() {
  if (ixBusy) return;
  const prompt = $('#ixChunkPrompt').value.trim();
  if (!prompt) { ixSetStatus('Please enter a prompt for this chunk.'); return; }
  ixBusy = true;
  const btn = $('#ixGenBtn');
  btn.disabled = true;
  btn.textContent = 'Generating...';
  ixSetStatus(`Generating chunk ${ixCurrentChunk + 1}... (this may take 30-120s)`);

  try {
    const result = await fetchJSON('/api/interactive/generate_chunk', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ user_prompt: prompt, skip_ai: true }),
    });
    ixChunks.push({
      num: result.chunk_num,
      time_range: result.time_range,
      prompt: prompt,
    });
    ixCurrentChunk = result.chunk_num;

    if (result.chunk_video_url) ixShowVideo('ixChunkBox', result.chunk_video_url);
    if (result.running_video_url) ixShowVideo('ixFullBox', result.running_video_url);

    ixRenderHistory();
    ixUpdateChunkInfo();
    ixUpdateNavButtons();
    ixSetStatus(
      `Chunk ${result.chunk_num} generated in ${result.generation_time}!\n` +
      `Time range: ${result.time_range}\n\n` +
      `Ready for chunk ${ixCurrentChunk + 1}. Enter next prompt or click Finalize.`
    );
    $('#ixChunkPrompt').value = '';
  } catch (e) {
    ixSetStatus(`Generation failed: ${e.message || e}`);
  }
  btn.disabled = false;
  btn.textContent = 'Generate Chunk';
  ixBusy = false;
}

async function ixGoBack() {
  if (ixBusy || ixCurrentChunk === 0) return;
  ixBusy = true;
  ixSetStatus('Going back one chunk...');
  try {
    const result = await fetchJSON('/api/interactive/go_back', { method: 'POST' });
    if (result.status === 'error') {
      ixSetStatus(result.message);
    } else {
      ixCurrentChunk = Math.max(0, ixCurrentChunk - 1);
      if (ixChunks.length > ixCurrentChunk) ixChunks.length = ixCurrentChunk;
      ixRenderHistory();
      ixUpdateChunkInfo();
      ixUpdateNavButtons();
      ixSetStatus(`Went back. Now at chunk ${ixCurrentChunk + 1}.\nEnter a new prompt for this chunk.`);
      try {
        const st = await fetchJSON('/api/interactive/status');
        if (st.last_chunk_url) ixShowVideo('ixChunkBox', st.last_chunk_url);
        else ixClearVideo('ixChunkBox', 'No chunk generated yet');
        if (st.running_video_url) ixShowVideo('ixFullBox', st.running_video_url);
        else ixClearVideo('ixFullBox', 'Generate chunks to build video');
      } catch(e) {}
    }
  } catch (e) {
    ixSetStatus(`Go back failed: ${e.message || e}`);
  }
  ixBusy = false;
}

async function ixFinalize() {
  if (ixBusy || ixCurrentChunk === 0) return;
  ixBusy = true;
  ixSetStatus('Assembling final video...');
  try {
    const result = await fetchJSON('/api/interactive/finalize', { method: 'POST' });
    if (result.status === 'error') {
      ixSetStatus(result.message);
    } else {
      ixSetStatus(
        `Video finalized!\n` +
        `Duration: ${result.duration} | Chunks: ${result.total_chunks}\n\n` +
        `Click Reset to start a new video.`
      );
      if (result.final_video_url) {
        $('#ixFinalSection').style.display = '';
        ixShowVideo('ixFinalBox', result.final_video_url);
      }
    }
  } catch (e) {
    ixSetStatus(`Finalize failed: ${e.message || e}`);
  }
  ixBusy = false;
}

async function ixReset() {
  if (ixBusy) return;
  if (ixChunks.length > 0 && !confirm('Reset session? All generated chunks will be lost.')) return;
  ixBusy = true;
  ixSetStatus('Resetting session...');
  try {
    const result = await fetchJSON('/api/interactive/reset', { method: 'POST' });
    ixGroundingSet = false;
    ixCurrentChunk = 0;
    ixChunks = [];
    $('#ixChunkSection').style.display = 'none';
    $('#ixFinalSection').style.display = 'none';
    $('#ixGrounding').value = '';
    $('#ixChunkPrompt').value = '';
    ixClearVideo('ixChunkBox', 'No chunk generated yet');
    ixClearVideo('ixFullBox', 'Generate chunks to build video');
    ixRenderHistory();
    ixUpdateNavButtons();
    ixSetStatus(
      `Session reset! New session: ${result.new_session_id}\n\n` +
      `Describe the main scene below.`
    );
  } catch (e) {
    ixSetStatus(`Reset failed: ${e.message || e}`);
  }
  ixBusy = false;
}
</script>
</body>
</html>
